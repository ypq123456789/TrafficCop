# ç”¨æˆ·ä½“éªŒä¼˜åŒ–ä¿®å¤è¯´æ˜ (v1.3)

## ğŸ“ é—®é¢˜æ¦‚è¿°

ç”¨æˆ·åé¦ˆäº†ä¸‰ä¸ªç”¨æˆ·ä½“éªŒé—®é¢˜ï¼š

1. **ç«¯å£æµé‡ç›‘æ§é…ç½®æ˜¾ç¤ºé—®é¢˜** - æ˜¾ç¤ºæ—§æ ¼å¼é…ç½®æ–‡ä»¶ï¼Œå®é™…å·²æ”¹ç”¨JSONæ ¼å¼
2. **æµé‡æ˜¾ç¤ºæ ¼å¼é—®é¢˜** - æ˜¾ç¤º `.02GB` è€Œä¸æ˜¯ `0.02GB`ï¼ˆç¼ºå°‘å‰å¯¼é›¶ï¼‰
3. **ä¸»èœå•æ ‡é¢˜ä¸æ¸…æ™°** - "å®‰è£…XXX"åº”è¯¥æ”¹ä¸º"å®‰è£…/ç®¡ç†XXX"

---

## ğŸ”§ ä¿®å¤è¯¦æƒ…

### ä¿®å¤ 1ï¼šç«¯å£æµé‡ç›‘æ§é…ç½®æ˜¾ç¤º

**é—®é¢˜æè¿°ï¼š**
```bash
# æ—§çš„æ˜¾ç¤ºï¼ˆé”™è¯¯ï¼‰
PORT=15836
PORT_TRAFFIC_LIMIT=100
PORT_TRAFFIC_TOLERANCE=0
...
```

è¿™æ˜¯æ—§ç‰ˆæœ¬çš„å•ç«¯å£é…ç½®æ ¼å¼ï¼Œv2.0+ å·²æ”¹ç”¨ JSON æ ¼å¼ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

ä¿®æ”¹ `trafficcop-manager.sh` ä¸­çš„ `view_config()` å‡½æ•°ï¼š

```bash
5)
    if [ -f "$WORK_DIR/ports_traffic_config.json" ]; then
        echo -e "${GREEN}ç«¯å£æµé‡ç›‘æ§é…ç½®ï¼ˆJSONæ ¼å¼ï¼‰ï¼š${NC}"
        echo ""
        
        # æ£€æŸ¥æ˜¯å¦æœ‰jqï¼Œæœ‰çš„è¯æ ¼å¼åŒ–è¾“å‡º
        if command -v jq &> /dev/null; then
            jq '.' "$WORK_DIR/ports_traffic_config.json"
        else
            cat "$WORK_DIR/ports_traffic_config.json"
        fi
        
        echo ""
        echo -e "${CYAN}=== ç«¯å£æµé‡ä½¿ç”¨æƒ…å†µ ===${NC}"
        
        # è°ƒç”¨ view_port_traffic.sh æ˜¾ç¤ºå®æ—¶æµé‡
        if [ -f "$WORK_DIR/view_port_traffic.sh" ]; then
            bash "$WORK_DIR/view_port_traffic.sh"
        else
            echo -e "${YELLOW}view_port_traffic.sh è„šæœ¬ä¸å­˜åœ¨${NC}"
        fi
    else
        echo -e "${RED}ç«¯å£æµé‡ç›‘æ§é…ç½®ä¸å­˜åœ¨${NC}"
        echo -e "${YELLOW}æç¤ºï¼šè¯·å…ˆä½¿ç”¨èœå•é€‰é¡¹ 5) å®‰è£…/ç®¡ç†ç«¯å£æµé‡é™åˆ¶${NC}"
    fi
    ;;
```

**æ•ˆæœï¼š**
- âœ… æ˜¾ç¤ºæ­£ç¡®çš„ JSON é…ç½®æ–‡ä»¶
- âœ… ä½¿ç”¨ jq æ ¼å¼åŒ–è¾“å‡ºï¼ˆå¦‚æœå®‰è£…äº†ï¼‰
- âœ… åŒæ—¶æ˜¾ç¤ºå®æ—¶æµé‡ä½¿ç”¨æƒ…å†µ
- âœ… æä¾›å‹å¥½çš„æç¤ºä¿¡æ¯

---

### ä¿®å¤ 2ï¼šæµé‡æ˜¾ç¤ºæ ¼å¼é—®é¢˜ï¼ˆå‰å¯¼é›¶ï¼‰

**é—®é¢˜æè¿°ï¼š**
```bash
# é”™è¯¯æ˜¾ç¤º
.02GB    # ç¼ºå°‘å‰å¯¼é›¶
.50GB
.99GB

# æ­£ç¡®æ˜¾ç¤º
0.02GB   # æœ‰å‰å¯¼é›¶
0.50GB
0.99GB
```

**æ ¹æœ¬åŸå› ï¼š**

`bc` å‘½ä»¤åœ¨è¾“å‡ºå°æ•°æ—¶ä¼šçœç•¥å‰å¯¼é›¶ï¼š
```bash
echo "scale=2; 0.02" | bc
# è¾“å‡º: .02  âŒ é”™è¯¯

printf "%.2f" $(echo "scale=2; 0.02" | bc)
# è¾“å‡º: 0.02  âœ… æ­£ç¡®
```

**ä¿®å¤ä½ç½®ï¼š**

#### 2.1 `port_traffic_limit.sh` - `get_port_traffic_usage()` å‡½æ•°

**ä¿®æ”¹å‰ï¼š**
```bash
# è½¬æ¢ä¸ºGB
local in_gb=$(echo "scale=2; $in_bytes / 1024 / 1024 / 1024" | bc)
local out_gb=$(echo "scale=2; $out_bytes / 1024 / 1024 / 1024" | bc)
local total_gb=$(echo "scale=2; $in_gb + $out_gb" | bc)
```

**ä¿®æ”¹åï¼š**
```bash
# è½¬æ¢ä¸ºGBï¼ˆä½¿ç”¨printfæ ¼å¼åŒ–ï¼Œç¡®ä¿æ˜¾ç¤ºå‰å¯¼é›¶ï¼‰
local in_gb=$(printf "%.2f" $(echo "scale=2; $in_bytes / 1024 / 1024 / 1024" | bc))
local out_gb=$(printf "%.2f" $(echo "scale=2; $out_bytes / 1024 / 1024 / 1024" | bc))
local total_gb=$(printf "%.2f" $(echo "scale=2; $in_gb + $out_gb" | bc))
```

#### 2.2 `view_port_traffic.sh` - `get_port_traffic_usage()` å‡½æ•°

**ä¿®æ”¹å‰ï¼š**
```bash
if [ -n "$usage_bytes" ] && [ "$usage_bytes" -gt 0 ]; then
    echo "scale=3; $usage_bytes/1024/1024/1024" | bc
else
    echo "0.000"
fi
```

**ä¿®æ”¹åï¼š**
```bash
if [ -n "$usage_bytes" ] && [ "$usage_bytes" -gt 0 ]; then
    # ä½¿ç”¨ printf ç¡®ä¿æ˜¾ç¤ºå‰å¯¼é›¶ï¼ˆä¾‹å¦‚ 0.02 è€Œä¸æ˜¯ .02ï¼‰
    printf "%.3f" $(echo "scale=3; $usage_bytes/1024/1024/1024" | bc)
else
    echo "0.000"
fi
```

#### 2.3 `view_port_traffic.sh` - `calculate_percentage()` å‡½æ•°

**ä¿®æ”¹å‰ï¼š**
```bash
if (( $(echo "$limit > 0" | bc -l) )); then
    echo "scale=2; ($usage / $limit) * 100" | bc
else
    echo "0.00"
fi
```

**ä¿®æ”¹åï¼š**
```bash
if (( $(echo "$limit > 0" | bc -l) )); then
    # ä½¿ç”¨ printf ç¡®ä¿æ˜¾ç¤ºå‰å¯¼é›¶
    printf "%.2f" $(echo "scale=2; ($usage / $limit) * 100" | bc)
else
    echo "0.00"
fi
```

**æ•ˆæœï¼š**
- âœ… æ‰€æœ‰æµé‡æ˜¾ç¤ºéƒ½æœ‰å‰å¯¼é›¶
- âœ… ç™¾åˆ†æ¯”æ˜¾ç¤ºä¹Ÿæœ‰å‰å¯¼é›¶
- âœ… ç»Ÿä¸€çš„æ•°å­—æ ¼å¼

---

### ä¿®å¤ 3ï¼šä¸»èœå•æ ‡é¢˜ä¼˜åŒ–

**é—®é¢˜æè¿°ï¼š**

ä¸»èœå•æ˜¾ç¤º"å®‰è£…XXX"ï¼Œä½†å®é™…è¿™äº›é€‰é¡¹æ—¢å¯ä»¥å®‰è£…ä¹Ÿå¯ä»¥ç®¡ç†ï¼ˆé‡æ–°é…ç½®ï¼‰ã€‚

**ä¿®æ”¹å‰ï¼š**
```bash
1) å®‰è£…æµé‡ç›‘æ§
2) å®‰è£…Telegramé€šçŸ¥åŠŸèƒ½
3) å®‰è£…PushPlusé€šçŸ¥åŠŸèƒ½
4) å®‰è£…Serveré…±é€šçŸ¥åŠŸèƒ½
5) å®‰è£…/ç®¡ç†ç«¯å£æµé‡é™åˆ¶
```

**ä¿®æ”¹åï¼š**
```bash
1) å®‰è£…/ç®¡ç†æµé‡ç›‘æ§
2) å®‰è£…/ç®¡ç†Telegramé€šçŸ¥
3) å®‰è£…/ç®¡ç†PushPlusé€šçŸ¥
4) å®‰è£…/ç®¡ç†Serveré…±é€šçŸ¥
5) å®‰è£…/ç®¡ç†ç«¯å£æµé‡é™åˆ¶
```

**è¯´æ˜ï¼š**
- âœ… æ ‡é¢˜æ›´å‡†ç¡®åæ˜ åŠŸèƒ½
- âœ… ç»Ÿä¸€æ ¼å¼ï¼ˆæ‰€æœ‰é€‰é¡¹éƒ½æ˜¯"å®‰è£…/ç®¡ç†"ï¼‰
- âœ… ç”¨æˆ·æ›´æ¸…æ¥šå¯ä»¥é‡æ–°é…ç½®

**å…³äº"æŒ‰Enterä¿ç•™åŸé…ç½®"ï¼š**

å„ä¸ªé€šçŸ¥è„šæœ¬ï¼ˆ`tg_notifier.sh`, `pushplus_notifier.sh` ç­‰ï¼‰**å·²ç»å†…ç½®äº†è¿™ä¸ªåŠŸèƒ½**ï¼š

```bash
# ç¤ºä¾‹ï¼štg_notifier.sh
read -p "è¯·è¾“å…¥Telegram Bot Token [å½“å‰: $BOT_TOKEN]: " new_token
BOT_TOKEN=${new_token:-$BOT_TOKEN}  # å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œä¿ç•™åŸå€¼
```

æ‰€ä»¥ä¸»èœå•ä¸éœ€è¦é¢å¤–ä¿®æ”¹ï¼Œåªéœ€æ›´æ–°æ ‡é¢˜å³å¯ã€‚

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ç«¯å£æµé‡é…ç½®æ˜¾ç¤º

**ä¿®æ”¹å‰ï¼š**
```
PORT=15836
PORT_TRAFFIC_LIMIT=100
PORT_TRAFFIC_TOLERANCE=0
...
```

**ä¿®æ”¹åï¼š**
```
ç«¯å£æµé‡ç›‘æ§é…ç½®ï¼ˆJSONæ ¼å¼ï¼‰ï¼š

{
  "ports": [
    {
      "port": 12123,
      "description": "Port 12123",
      "traffic_limit": 100,
      "traffic_tolerance": 2,
      "traffic_mode": "total",
      "limit_mode": "tc",
      "limit_speed": 20,
      "main_interface": "eth0"
    },
    {
      "port": 12321,
      "description": "Port 12321",
      "traffic_limit": 100,
      ...
    }
  ]
}

=== ç«¯å£æµé‡ä½¿ç”¨æƒ…å†µ ===

ç«¯å£æµé‡ç›‘æ§ - Port Traffic Limit v2.2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç«¯å£      æè¿°           ä½¿ç”¨é‡      é™åˆ¶      çŠ¶æ€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
12123     Port 12123     42.35 GB   100 GB    æ­£å¸¸ (42.35%)
12321     Port 12321     15.23 GB   100 GB    æ­£å¸¸ (15.23%)
232       Port 232       0.02 GB    100 GB    æ­£å¸¸ (0.02%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### æµé‡æ˜¾ç¤ºæ ¼å¼

**ä¿®æ”¹å‰ï¼š**
```
ç«¯å£ 232: .02 GB / 100 GB (.02%)     âŒ
ç«¯å£ 123: .50 GB / 100 GB (.50%)     âŒ
```

**ä¿®æ”¹åï¼š**
```
ç«¯å£ 232: 0.02 GB / 100 GB (0.02%)   âœ…
ç«¯å£ 123: 0.50 GB / 100 GB (0.50%)   âœ…
```

### ä¸»èœå•

**ä¿®æ”¹å‰ï¼š**
```
1) å®‰è£…æµé‡ç›‘æ§
2) å®‰è£…Telegramé€šçŸ¥åŠŸèƒ½
```

**ä¿®æ”¹åï¼š**
```
1) å®‰è£…/ç®¡ç†æµé‡ç›‘æ§
2) å®‰è£…/ç®¡ç†Telegramé€šçŸ¥
```

---

## ğŸš€ æ›´æ–°æ­¥éª¤

### åœ¨æœåŠ¡å™¨ä¸Šæ›´æ–°

```bash
# 1. æ›´æ–° trafficcop-manager.sh
cd /root/TrafficCop
wget -O trafficcop-manager.sh https://raw.githubusercontent.com/ypq123456789/TrafficCop/main/trafficcop-manager.sh
chmod +x trafficcop-manager.sh

# 2. æ›´æ–° port_traffic_limit.sh
wget -O port_traffic_limit.sh https://raw.githubusercontent.com/ypq123456789/TrafficCop/main/port_traffic_limit.sh
chmod +x port_traffic_limit.sh

# 3. æ›´æ–° view_port_traffic.sh
wget -O view_port_traffic.sh https://raw.githubusercontent.com/ypq123456789/TrafficCop/main/view_port_traffic.sh
chmod +x view_port_traffic.sh

# 4. éªŒè¯ç‰ˆæœ¬
bash trafficcop-manager.sh
# åº”è¯¥æ˜¾ç¤º: TrafficCop ç®¡ç†å·¥å…· v1.3
```

### æµ‹è¯•æ–°åŠŸèƒ½

```bash
# 1. æµ‹è¯•ç«¯å£é…ç½®æ˜¾ç¤º
bash trafficcop-manager.sh
# é€‰æ‹©: 8 â†’ 5

# 2. æµ‹è¯•æµé‡æ˜¾ç¤ºæ ¼å¼
bash /root/TrafficCop/view_port_traffic.sh

# 3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„æµé‡æ ¼å¼
tail -20 /root/TrafficCop/port_traffic_monitor.log
```

---

## âœ… éªŒè¯æ¸…å•

- [ ] ç®¡ç†å·¥å…·æ˜¾ç¤ºç‰ˆæœ¬ v1.3
- [ ] ä¸»èœå•é€‰é¡¹æ˜¾ç¤º"å®‰è£…/ç®¡ç†"
- [ ] æŸ¥çœ‹ç«¯å£é…ç½®æ˜¾ç¤º JSON æ ¼å¼
- [ ] æŸ¥çœ‹ç«¯å£é…ç½®æ˜¾ç¤ºå®æ—¶æµé‡ä½¿ç”¨æƒ…å†µ
- [ ] æµé‡æ˜¾ç¤ºéƒ½æœ‰å‰å¯¼é›¶ï¼ˆ0.02GB è€Œä¸æ˜¯ .02GBï¼‰
- [ ] ç™¾åˆ†æ¯”æ˜¾ç¤ºéƒ½æœ‰å‰å¯¼é›¶ï¼ˆ0.02% è€Œä¸æ˜¯ .02%ï¼‰
- [ ] æ—¥å¿—ä¸­çš„æµé‡æ ¼å¼æ­£ç¡®

---

## ğŸ“¦ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### trafficcop-manager.sh
- **ç‰ˆæœ¬ï¼š** 1.2 â†’ 1.3
- **ä¿®æ”¹å†…å®¹ï¼š**
  - ä¿®å¤ç«¯å£æµé‡é…ç½®æ˜¾ç¤ºï¼ˆJSONæ ¼å¼ + å®æ—¶æµé‡ï¼‰
  - ä¸»èœå•æ ‡é¢˜ä¼˜åŒ–ï¼ˆ"å®‰è£…" â†’ "å®‰è£…/ç®¡ç†"ï¼‰

### port_traffic_limit.sh
- **ç‰ˆæœ¬ï¼š** 2.2ï¼ˆæ— å˜æ›´ï¼‰
- **ä¿®æ”¹å†…å®¹ï¼š**
  - `get_port_traffic_usage()` ä½¿ç”¨ `printf` æ ¼å¼åŒ–è¾“å‡º

### view_port_traffic.sh
- **ç‰ˆæœ¬ï¼š** æ— ç‰ˆæœ¬å·
- **ä¿®æ”¹å†…å®¹ï¼š**
  - `get_port_traffic_usage()` ä½¿ç”¨ `printf` æ ¼å¼åŒ–è¾“å‡º
  - `calculate_percentage()` ä½¿ç”¨ `printf` æ ¼å¼åŒ–è¾“å‡º

---

## ğŸ¯ æŠ€æœ¯ç»†èŠ‚

### printf vs bc

**é—®é¢˜ï¼š**
```bash
echo "scale=2; 0.02" | bc
# è¾“å‡º: .02
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
printf "%.2f" $(echo "scale=2; 0.02" | bc)
# è¾“å‡º: 0.02
```

**printf æ ¼å¼è¯´æ˜ï¼š**
- `%.2f` - ä¿ç•™2ä½å°æ•°çš„æµ®ç‚¹æ•°
- `%.3f` - ä¿ç•™3ä½å°æ•°çš„æµ®ç‚¹æ•°
- è‡ªåŠ¨æ·»åŠ å‰å¯¼é›¶
- è‡ªåŠ¨å››èˆäº”å…¥

### JSON é…ç½®æ˜¾ç¤º

ä½¿ç”¨ `jq` å·¥å…·æ ¼å¼åŒ– JSON è¾“å‡ºï¼š

```bash
if command -v jq &> /dev/null; then
    jq '.' "$WORK_DIR/ports_traffic_config.json"
else
    cat "$WORK_DIR/ports_traffic_config.json"
fi
```

**ä¼˜åŠ¿ï¼š**
- âœ… è‡ªåŠ¨æ ¼å¼åŒ–å’Œç¼©è¿›
- âœ… è¯­æ³•é«˜äº®ï¼ˆå¦‚æœç»ˆç«¯æ”¯æŒï¼‰
- âœ… å¦‚æœæ²¡æœ‰ jqï¼Œé™çº§ä¸º cat

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: æ›´æ–°åè¿˜æ˜¯æ˜¾ç¤ºæ—§çš„é…ç½®æ ¼å¼ï¼Ÿ

**åŸå› ï¼š** ç³»ç»Ÿä¸­è¿˜å­˜åœ¨æ—§çš„ `port_traffic_config.txt` æ–‡ä»¶ã€‚

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥æ—§é…ç½®æ–‡ä»¶
ls -lh /root/TrafficCop/port_traffic_config.txt

# å¦‚æœå­˜åœ¨ï¼Œå¯ä»¥åˆ é™¤ï¼ˆå·²è¿ç§»åˆ°JSONï¼‰
rm /root/TrafficCop/port_traffic_config.txt
```

---

### Q2: æµé‡æ˜¾ç¤ºè¿˜æ˜¯æ²¡æœ‰å‰å¯¼é›¶ï¼Ÿ

**åŸå› ï¼š** è„šæœ¬æ²¡æœ‰æ­£ç¡®æ›´æ–°ã€‚

**è§£å†³ï¼š**
```bash
# é‡æ–°ä¸‹è½½æ‰€æœ‰è„šæœ¬
cd /root/TrafficCop
wget -O port_traffic_limit.sh https://raw.githubusercontent.com/ypq123456789/TrafficCop/main/port_traffic_limit.sh
wget -O view_port_traffic.sh https://raw.githubusercontent.com/ypq123456789/TrafficCop/main/view_port_traffic.sh
chmod +x *.sh

# æ‰‹åŠ¨æµ‹è¯•
bash view_port_traffic.sh
```

---

### Q3: jq å‘½ä»¤ä¸å­˜åœ¨ï¼Ÿ

**è§£å†³ï¼š**
```bash
# Debian/Ubuntu
apt update && apt install -y jq

# CentOS/RHEL
yum install -y jq

# æˆ–è€…ä¸å®‰è£… jqï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹ JSON
cat /root/TrafficCop/ports_traffic_config.json
```

---

## ğŸ‰ æ€»ç»“

**ä¿®å¤å†…å®¹ï¼š**
1. âœ… ç«¯å£æµé‡é…ç½®æ˜¾ç¤ºä¿®å¤ï¼ˆJSONæ ¼å¼ + å®æ—¶æµé‡ï¼‰
2. âœ… æµé‡æ˜¾ç¤ºæ ¼å¼ä¿®å¤ï¼ˆå‰å¯¼é›¶ï¼‰
3. âœ… ä¸»èœå•æ ‡é¢˜ä¼˜åŒ–ï¼ˆ"å®‰è£…/ç®¡ç†"ï¼‰

**ç‰ˆæœ¬æ›´æ–°ï¼š**
- trafficcop-manager.sh: v1.2 â†’ v1.3
- port_traffic_limit.sh: v2.2ï¼ˆæµé‡æ ¼å¼ä¿®å¤ï¼‰
- view_port_traffic.sh: æµé‡æ ¼å¼ä¿®å¤

**å½±å“èŒƒå›´ï¼š**
- âœ… é…ç½®æŸ¥çœ‹åŠŸèƒ½
- âœ… æµé‡æ˜¾ç¤ºï¼ˆæ—¥å¿—ã€ç•Œé¢ï¼‰
- âœ… ä¸»èœå•æ ‡é¢˜

**æ¨é€çŠ¶æ€ï¼š** å¾…æ¨é€åˆ° GitHub

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´ï¼š** 2025-10-19 03:10  
**ä¿®å¤ç‰ˆæœ¬ï¼š** trafficcop-manager v1.3  
**çŠ¶æ€ï¼š** âœ… æœ¬åœ°ä¿®å¤å®Œæˆï¼Œå¾…æµ‹è¯•å¹¶æ¨é€
